{% extends "base.html" %}
{% block content %}
<div id="editor"></div>

<dialog id="bapSettings">
	<button onclick="closeAllDialogs()">X</button>
	<select id="langOption">
	</select>

	<!--
	<button onclick="pickLang()" id="langOpenDropdown"></button>
	<div id="langDropdown" class="dropdown-content">

	</div>
	-->
</dialog>

<style>
    html, body, #editor {
        position: absolute;
        left: 0;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    body {
        width: calc(100% - 56px) !important;
    }
</style>

<script>
    // sources setup
    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.45.0/min/vs' }});
    window.MonacoEnvironment = { getWorkerUrl: () => proxy };

    let proxy = URL.createObjectURL(new Blob([`
    	self.MonacoEnvironment = {
    		baseUrl: 'https://unpkg.com/monaco-editor@0.45.0/min/'
    	};
    	importScripts('https://unpkg.com/monaco-editor@0.45.0/min/vs/base/worker/workerMain.js');
    `], { type: 'text/javascript' }));


    // editor init
    let editor

    require(["vs/editor/editor.main"], function () {
    	editor = monaco.editor.create(document.getElementById('editor'), {
    		//value: [
    		//	'function x() {',
    		//	'\tconsole.log("Hello world!");',
    		//	'}'
    		//].join('\n'),
    		//language: 'javascript',
        automaticLayout: true,
        minimap: {enabled: false, },
    		theme: 'vs-dark'
    	});
    });

    function upload() {
        fetch('/api/', {
            method: "POST",
            body: JSON.stringify({
                content: editor.getValue(),
				lang: null
            }),
            headers: {
              "Content-type": "application/json; charset=UTF-8"
            }
        })
            .then(response => {
                if (response.ok) {
                    editor.setValue("")
                    response.json().then(json =>{
                        const new_url = '/bap/' + json['id'];

                        // htmx.ajax('GET', new_url, '#content')
                        //     .then(() => {
                        //         history.pushState(null, "", new_url)
                        //     })
						window.location.href = new_url;
                    })
                } else {
                    alert(response.statusText)
                }
            })
    }

	const langOpts = document.getElementById("langOption")

	/**
	* Add a language option to language selector
	* @param {string} name
	* @param {string} value
	*/
	function addLanguageOption(name, value) {
		let option = document.createElement("option")
		let nameNode = document.createTextNode(name)

		option.appendChild(nameNode)
		option.setAttribute("value", value)
		langOpts.append(option)
	}

</script>
{% endblock %}
